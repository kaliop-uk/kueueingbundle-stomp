language: php

# Sudo: false should make the builds faster, but collides with rabbitmq
sudo: true

php:
  - 5.3
#  - 5.4
#  - 5.5
#  - 5.6
#  - 7.0
#  - hhvm

env:
  # Test only on versions of Sf that are still supported
  - SYMFONY_VERSION=2.3.* BROKER=apollo
#  - SYMFONY_VERSION=2.6.* BROKER=apollo
#  - SYMFONY_VERSION=2.7.* BROKER=apollo

#  - SYMFONY_VERSION=2.3.* BROKER=rabbitmq
#  - SYMFONY_VERSION=2.6.* BROKER=rabbitmq
#  - SYMFONY_VERSION=2.7.* BROKER=rabbitmq

#  - SYMFONY_VERSION=2.3.* BROKER=activemq
  - SYMFONY_VERSION=2.6.* BROKER=activemq
#  - SYMFONY_VERSION=2.7.* BROKER=activemq

matrix:
  allow_failures:
    # at the moment it gives a core dump because of generation of code coverage...
    #- php: 5.6

services:
  - rabbitmq

before_install:
  # This is mandatory or 'apt-get install' calls following will fail
  - if [ "$BROKER" = "activemq" ]; then sudo apt-get update -qq && sudo apt-get install activemq; fi
  # Install a more recent Xdebug version, as the default one (2.2.7) crashes when generating code coverage
  #- if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then ./Tests/travis/setup_xdebug.sh; fi
  - ./Tests/travis/setup_broker.sh $BROKER

install:
  - composer self-update
  - composer require --prefer-source --dev symfony/symfony:${SYMFONY_VERSION}
  - composer install

before_script:
  # Disable xdebug for speed.
  # NB: this should NOT be done for hhvm and php 7.0.
  # Also we use the php 5.6 run to generate code coverage reports, and we need xdebug for that
  - if [ "$TRAVIS_PHP_VERSION" != "hhvm" -a "$TRAVIS_PHP_VERSION" != "7.0" -a "$TRAVIS_PHP_VERSION" != "5.6" ]; then phpenv config-rm xdebug.ini; fi
  - cp phpunit.xml.dist phpunit.xml

script:
  phpunit --coverage-clover=coverage.clover Tests/phpunit

after_failure:
  # Display as much info as we can to help developers
  - if [ "$TRAVIS_PHP_VERSION" != "hhvm" ]; then php -i; fi

after_script:
  # Upload code-coverage to Scrutinizer
  - if [ "$TRAVIS_PHP_VERSION" = "5.6" -a -f coverage.clover ]; then wget https://scrutinizer-ci.com/ocular.phar; fi
  - if [ "$TRAVIS_PHP_VERSION" = "5.6" -a -f coverage.clover ]; then php ocular.phar code-coverage:upload --format=php-clover coverage.clover; fi
  # Upload code-coverage to CodeClimate
  - if [ "$TRAVIS_PHP_VERSION" = "5.6" -a -f coverage.clover ]; then CODECLIMATE_REPO_TOKEN=TOBEGOTTEN ./vendor/bin/test-reporter --coverage-report=coverage.clover; fi

cache:
  directories:
    - $COMPOSER_CACHE_DIR
